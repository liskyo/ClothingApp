# 專案架構及程式碼分析

本文件針對 `ClothingApp` 專案進行架構與程式碼的深度分析。該專案主要功能為**虛擬試穿 (Virtual Try-On)** 應用程式，結合了 **FastAPI** 後端與 **Vue.3** 前端，並利用生成式 AI (Gemini, OOTDiffusion) 進行影像分析與生成。

## 1. 技術堆疊 (Tech Stack)

| 層級 | 技術 / 套件 | 說明 |
| :--- | :--- | :--- |
| **Backend** | **Python (FastAPI)** | 高效能非同步 Web 框架。 |
| **Frontend** | **Vue.3 + Vite** | 現代化前端框架與建置工具。 |
| **Styling** | **Tailwind CSS** | Utility-first CSS 框架，用於快速切版與美化。 |
| **AI Services** | **Google Gemini** | 用於圖片風格分析、使用者照片驗證 (全身/正面檢測)。 |
| **AI Services** | **OOTDiffusion** (via Gradio) | 核心虛擬試穿模型 (Open Outpaint Try-on Diffusion)。 |
| **Deployment** | **Vercel** | 設定檔顯示支援 Serverless Python API 與靜態前端部署。 |
| **Storage** | **MongoDB Atlas / Cloudinary** | 支援雲端資料庫與圖片儲存 (亦保留 Local FS 為降級備案)。 |

---

## 2. 專案結構 (Project Structure)

```text
ClothingApp/
├── api/                  # Vercel Serverless Entry Points
│   └── index.py          # 橋接 FastAPI 至 Vercel 的進入點
├── backend/              # 後端核心程式碼
│   ├── main.py           # FastAPI 應用程式入口、API 定義 (含 Cloudinary 整合)
│   ├── ai_service.py     # AI 邏輯封裝 (Gemini 分析, OOTD 試穿)
│   ├── clothes_manager.py# 服飾資料 CRUD 管理 (支援 MongoDB / Local JSON)
│   └── ...
├── frontend/             # 前端原始碼
│   ├── src/
│   │   ├── components/   # Vue 元件 (AdminPanel, UserPanel)
│   │   ├── App.vue       # 主程式入口 (Layout)
│   │   └── ...
│   ├── package.json      # 前端依賴定義 (Vue, Tailwind, Axios)
│   └── vite.config.ts    # Vite 建置設定
├── model/                # 本地開發資料存放區 (圖片, clothes.json - Fallback 用)
├── .env                  # 環境變數設定 (MongoDB URI, Cloudinary URL, API Keys)
└── vercel.json           # Vercel 部署設定
```

---

## 3. 核心功能與程式碼分析

### 3.1 後端 (Backend)

主要邏輯位於 `backend/` 目錄，由 `main.py` 整合各項服務，並採 **Hybrid Mode (混合模式)** 架構。

#### **混合模式架構 (Hybrid Mode)**
*   **資料庫**: 自動偵測 `MONGODB_URI`環境變數。若存在則連線至 **MongoDB Atlas**；若不存在則降級使用本地 `model/clothes.json`。
*   **圖片儲存**: 自動偵測 `CLOUDINARY_URL`環境變數。若存在則上傳至 **Cloudinary**；若不存在則儲存於本地 `model/` 資料夾。
*   此設計確保專案既能滿足 Vercel Serverless 的無狀態需求，也能在無網際網路環境下進行本地開發。

#### **API 路由 (`backend/main.py`)**
*   **`GET /api/clothes`**: 取得服飾列表，支援篩選。回傳的圖片路徑會依據儲存模式，返回 Cloudinary URL 或本地路徑。
*   **`POST /api/upload`**: 管理員上傳服飾。
    *   **流程**: 接收圖片 -> 呼叫 Gemini 分析風格 -> 上傳圖片至 Cloudinary (或存本地) -> 寫入 MongoDB (或 JSON)。
*   **`DELETE /api/clothes/{id}` (New)**: 刪除服飾。
    *   **流程**: 從資料庫移除紀錄 -> 呼叫 Cloudinary API 刪除對應圖片 (釋放雲端空間)。
*   **`PUT /api/clothes/{id}` (New)**: 編輯服飾資訊 (名稱、風格、性別等)。
*   **`POST /api/try-on`**: 執行虛擬試穿 (VTON)。

#### **AI 服務 (`backend/ai_service.py`)** (不變)
*   整合 **Google Gemini** 進行風格分析與照片驗證。
*   整合 **OOTDiffusion** 進行虛擬試穿，包含 Smart Padding 預處理。

### 3.2 前端 (Frontend)

#### **介面架構**
*   **UserPanel**: 瀏覽服飾、上傳照片、試穿體驗。
*   **AdminPanel (更新)**: 
    *   **上傳功能**: 既有的 AI 分析與上傳。
    *   **服飾管理 (Manage Clothes)**: 新增 Grid View 列表，支援 **編輯 (Edit Modal)** 與 **刪除 (Delete)** 操作。同步整合後端 API，刪除時會由後端自動清理雲端資源。

### 3.3 部署架構 (Deployment)

*   **Vercel + Cloud**: 
    *   Web/API 託管於 Vercel。
    *   資料庫託管於 MongoDB Atlas。
    *   媒體庫託管於 Cloudinary。
    *   解決了 Serverless 環境下資料無法持久化的問題。

## 4. 總結與建議

### 已完成改進
1.  **資料持久化 (Cloud Migration)**: 成功遷移至 MongoDB 與 Cloudinary，解決 Vercel 部署後的資料遺失問題。
2.  **管理功能增強**: 實作了完整的 CRUD (新增、讀取、更新、刪除)，讓 ClothingApp 不再只是單向的展示工具，而是具備後台管理能力的應用。
3.  **混合架構**: 保持了開發彈性，本地開發無需強賴雲端服務即可運作。

### 未來展望
1.  **試穿速度**: 依賴外部免費的 Gradio Space，速度與穩定性不可控 (需排隊)。若要商用，建議部署專屬的推論 API (如 Replicate 私有部署)。
2.  **使用者帳戶**: 目前僅分 Admin/User 模式。未來可加入 Auth (如 NextAuth/Firebase Auth) 讓使用者保存自己的試穿紀錄。
