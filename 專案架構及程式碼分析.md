# 專案架構及程式碼分析

本文件針對 `ClothingApp` 專案進行架構與程式碼的深度分析。該專案主要功能為**虛擬試穿 (Virtual Try-On)** 應用程式，結合了 **FastAPI** 後端與 **Vue.3** 前端，並利用生成式 AI (Gemini, OOTDiffusion) 進行影像分析與生成。

## 1. 技術堆疊 (Tech Stack)

| 層級 | 技術 / 套件 | 說明 |
| :--- | :--- | :--- |
| **Backend** | **Python (FastAPI)** | 高效能非同步 Web 框架。 |
| **Frontend** | **Vue.3 + Vite** | 現代化前端框架與建置工具。 |
| **Styling** | **Tailwind CSS** | Utility-first CSS 框架，用於快速切版與美化。 |
| **AI Services** | **Google Gemini** | 用於圖片風格分析、使用者照片驗證 (全身/正面檢測)。 |
| **AI Services** | **OOTDiffusion** (via Gradio) | 核心虛擬試穿模型 (Open Outpaint Try-on Diffusion)。 |
| **Deployment** | **Vercel** | 設定檔顯示支援 Serverless Python API 與靜態前端部署。 |
| **Storage** | **JSON / Local FS** | 使用 `clothes.json` 進行輕量級資料儲存 (Prototype 階段)。 |

---

## 2. 專案結構 (Project Structure)

```text
ClothingApp/
├── api/                  # Vercel Serverless Entry Points
│   └── index.py          # 橋接 FastAPI 至 Vercel 的進入點
├── backend/              # 後端核心程式碼
│   ├── main.py           # FastAPI 應用程式入口、API 定義
│   ├── ai_service.py     # AI 邏輯封裝 (Gemini 分析, OOTD 試穿)
│   ├── clothes_manager.py# 服飾資料 CRUD 管理 (JSON based)
│   └── ...
├── frontend/             # 前端原始碼
│   ├── src/
│   │   ├── components/   # Vue 元件 (AdminPanel, UserPanel)
│   │   ├── App.vue       # 主程式入口 (Layout)
│   │   └── ...
│   ├── package.json      # 前端依賴定義 (Vue, Tailwind, Axios)
│   └── vite.config.ts    # Vite 建置設定
├── model/                # 資料存放區 (圖片, clothes.json)
└── vercel.json           # Vercel 部署設定
```

---

## 3. 核心功能與程式碼分析

### 3.1 後端 (Backend)

主要邏輯位於 `backend/` 目錄，由 `main.py` 整合各項服務。

#### **API 路由 (`backend/main.py`)**
*   **`GET /api/clothes`**: 取得服飾列表，支援依據 `gender` (性別) 與 `height` (身高範圍) 篩選。
*   **`POST /api/upload`**: 管理員上傳服飾。
    *   **流程**: 接收圖片 -> 呼叫 Gemini 分析風格 (`ai_service.analyze_image_style`) -> 儲存圖片與 JSON 資料。
*   **`POST /api/validate-avatar`**: 驗證使用者上傳的照片。
    *   **流程**: 呼叫 `ai_service.validate_and_crop_user_photo` -> 檢查是否為全身照、單人、正面 -> 如果驗證失敗回傳錯誤原因。
*   **`POST /api/try-on`**: 執行虛擬試穿。
    *   **流程**: 接收使用者照片與服飾 ID -> 呼叫 `ai_service.virtual_try_on` -> 回傳合成後的圖片。

#### **AI 服務 (`backend/ai_service.py`)**
這是專案的核心大腦，封裝了兩個主要的 AI 整合：
1.  **Google Gemini (影像分析)**:
    *   **風格分析**: 分析服飾的名稱、風格、甚至是版型。
    *   **照片驗證**: 透過 Prompt 工程，要求 AI 檢查照片是否符合試穿標準 (有頭、有腳、正面)。使用 Fail-Open 機制 (若 AI 解析失敗則預設通過)，避免阻擋使用者。
2.  **Virtual Try-On (OOTDiffusion)**:
    *   **整合方式**: 使用 `gradio_client` 連接 HuggingFace Space (`levihsu/OOTDiffusion`)。
    *   **圖片預處理**:
        *   **Smart Padding**: 強制將使用者照片補白邊至 **3:4 (0.75)** 比例，這是 OOTD 模型運作最佳的比例。
        *   **褲子特殊處理**: 針對下身 (Lower-body) 試穿，有防止寬褲變短褲的特殊裁切邏輯 (Side-Crop)。
    *   **後處理**: 將生成結果裁切回原始比例，並加上免責聲明浮水印。

#### **資料管理 (`backend/clothes_manager.py`)**
*   使用 `clothes.json` 檔案作為簡易資料庫。
*   實作了基本的 CRUD 與 ID 自動生成邏輯。
*   **注意**: 在 Vercel 環境下，檔案系統是 Read-Only (唯讀) 或 Ephemeral (暫存) 的，這意味著上傳的衣服與資料在重新部署後會消失，僅適合展示或開發測試。

### 3.2 前端 (Frontend)

採用 **Vue 3 Composition API** (`<script setup>`) 開發。

#### **介面架構 (`App.vue`)**
*   **雙模式切換**: 透過簡單的 `v-if` 切換 **"使用者試穿 (User)"** 與 **"管理員 (Admin)"** 模式。
*   **UI 風格**: 使用 Tailwind CSS 打造現代化深色風格 (Dark Mode)，包含玻璃擬態 (Glassmorphism) 導覽列與漸層按鈕。

#### **元件功能**
*   **`AdminPanel.vue` (推測)**: 提供服飾上傳表單，填寫身高、性別，並顯示 AI 自動分析的風格結果。
*   **`UserPanel.vue` (推測)**:
    1.  瀏覽並篩選服飾 (串接 `/api/clothes`)。
    2.  上傳個人全身照 (串接 `/api/validate-avatar`)。
    3.  選擇衣服進行試穿 (串接 `/api/try-on`) 並顯示結果。

### 3.3 部署架構 (Deployment)

*   **Vercel 設定 (`vercel.json`)**:
    *   定義了兩個 build：一個是 Python 後端 (`api/index.py`)，一個是前端靜態檔 (`frontend/package.json`)。
    *   路由規則將 `/api/*` 導向 Python 處理，其餘導向前端，實現了前後端分離但同源部署 (Same-origin)。

## 4. 總結與建議

### 優點
1.  **AI 整合完整**: 善用 Gemini 進行非核心的邏輯判斷 (驗證、分類)，大幅降低傳統 CV 演算法的開發成本。
2.  **使用者體驗優化**: 針對 VTON 常見的比例變形問題，實作了 Smart Padding 與強制的比例檢查。
3.  **架構清晰**: 前後端職責分離明確，程式碼結構易於維護。

### 潛在問題 / 改進方向
1.  **資料持久化**: 目前依賴本地 `clothes.json` 與檔案系統，不適合 Serverless 環境 (Vercel)。建議改用雲端資料庫 (MongoDB Atlas, Supabase) 與雲端儲存 (S3, Cloudinary) 來儲存服飾資料與圖片。
2.  **試穿速度**: 依賴外部免費的 Gradio Space，速度與穩定性不可控 (需排隊)。若要商用，建議部署專屬的推論 API (如 Replicate 私有部署)。
