# 專案架構及程式碼分析報告 v2

**專案名稱**: AI Virtual Try-On App (AI 虛擬試衣間)
**更新日期**: 2026-01-14
**版本**: v2.0 (Stable Release)

---

## 1. 專案概述 (Project Overview)
本專案為一個基於網頁的 AI 虛擬試衣應用程式。使用者可以上傳個人照片，並從衣櫃中選擇衣物，系統利用先進的生成式 AI 技術 (IDM-VTON) 將衣物自然地合成到使用者身上。

### 核心特色
*   **雙模組 AI 引擎**:結合高品質 Replicate (付費) 與 備援 Gradio (免費)，確保服務不中斷。
*   **混合式資料存儲**: 支援 MongoDB Atlas (雲端) 與 Local JSON (本地/備援) 雙存儲模式。
*   **Serverless 架構**: 後端針對 Vercel Serverless 環境優化，支援冷啟動與無狀態運行。
*   **智慧優先級邏輯**: 自動判斷使用雲端圖片或本地預設圖片，解決 ID 衝突問題。

---

## 2. 系統架構 (System Architecture)

### 技術堆疊 (Tech Stack)
*   **Frontend (前端)**:
    *   Framework: **Vue.js 3** (Composition API)
    *   Build Tool: **Vite**
    *   UI Library: TailwindCSS (推測), Custom CSS
    *   HTTP Client: Axios
*   **Backend (後端)**:
    *   Framework: **FastAPI** (Python 3.10+)
    *   Server: Uvicorn (Local), Vercel Serverless Functions (Prod)
*   **Database (資料庫)**:
    *   Primary: **MongoDB Atlas** (儲存衣物 Metadata 與 Cloudinary URL)
    *   Fallback: Local `clothes.json` (唯讀/開發測試用)
*   **AI Service (AI 服務)**:
    *   Primary Model: **Replicate (cuuupid/idm-vton:0513734a...)** - 高速、高畫質
    *   Fallback Model: **HuggingFace Gradio Client (yisol/IDM-VTON)** - 免費、無限次數
*   **Storage (檔案存儲)**:
    *   **Cloudinary**: 儲存使用者上傳的新增衣物圖片。
    *   **Vercel Temp**: 暫存處理中的使用者照片與合成結果。

### 架構圖 (Architecture Diagram)

```mermaid
graph TD
    User[使用者 User] -->|1. 上傳照片/選衣| Frontend[Vue.js 前端]
    Frontend -->|2. API 請求| Backend[FastAPI 後端]
    
    subgraph Data Layer
        Backend -->|3a. 讀寫資料| MongoDB[(MongoDB Atlas)]
        Backend -->|3b. 讀取預設| LocalJSON[Local clothes.json]
    end
    
    subgraph AI Processing
        Backend -->|4a. 優先嘗試| Replicate[Replicate API (Paid)]
        Replicate -.->|失敗 Fail| Gradio[Gradio Fallback (Free)]
        Backend -->|4b. 圖片下載| Cloudinary[Cloudinary Storage]
    end
    
    Replicate -->|5. 合成結果| Backend
    Gradio -->|5. 合成結果| Backend
    Backend -->|6. 回傳圖片| Frontend
```

---

## 3. 核心模組程式碼分析 (Code Analysis)

### 3.1 後端入口 (`backend/main.py`)
負責處理 API 請求、圖片下載與流程控制。

*   **關鍵邏輯：圖片來源優先級 (Image Priority)**
    *   **v2 更新**: 修正了本地檔案覆蓋雲端設定的問題。
    *   現在邏輯為：`Check Database URL` -> (若有) 下載 -> (若無) 使用 `OS Local Path`。
    *   這確保了使用者在 Admin 面板新增的 `ID 002` (針織衫) 不會被本地舊的 `ID 002` (格紋襯衫) 覆蓋。

*   **關鍵邏輯：錯誤處理與標頭**
    *   全域 Exception Handler 攔截 500 錯誤並記錄詳細 Traceback。
    *   Response Header 加入 `X-Storage-Mode: MongoDB/Local-JSON`，方便前端或開發者除錯。

### 3.2 AI 服務層 (`backend/ai_service.py`)
封裝了與外部 AI 模型的互動邏輯，是本專案最複雜的部分。

*   **Replicate 整合 (Primary)**
    *   **Hardcoded Version Hash**: 直接鎖定 `cuuupid/idm-vton:0513...` 版本，避免動態查詢 API 導致的 `NoneType` 錯誤或 `422 Invalid Version`。
    *   **Explicit Client**: 明確實例化 `replicate.Client`，確保 Token 正確傳遞。
    *   **IO Handling**: 使用 `io.BytesIO` 並賦予 `.name` 屬性，解決 Serverless 環境無法讀取實體檔案路徑的問題。

*   **自動備援機制 (Fallback Mechanism)**
    *   使用 `try-except` 包裹 Replicate 呼叫。
    *   若 Replicate 拋出任何錯誤 (如 `402 Payment Required`, `Connection Error`)，自動切換至 `virtual_try_on_gradio`。
    *   這保證了使用者永遠能得到結果，即使經費不足或 API 當機。

### 3.3 資料管理層 (`backend/clothes_manager.py`)
負責抽象化資料存取，讓上層邏輯不需要關心資料是來自 MongoDB 還是 JSON。

*   **連線偵測**: 啟動時檢查 `MONGODB_URI` 環境變數。
*   **SRV 支援**: 引入 `dnspython` 套件，支援 MongoDB Atlas 的 `mongodb+srv://` 連線字串。
*   **唯讀保護**: 在 Vercel 環境下，若無法寫入本地檔案 (Read-only filesystem)，會捕捉錯誤並繼續執行 (Volatile Mode)，避免程式崩潰。

---

## 4. 部署設定 (Deployment Configuration)

### Vercel (`vercel.json`)
*   **Builds**: 指定 Python 後端使用 `vercel/python` builder。
*   **Rewrites**: 將 `/api/*` 的請求導向 `api/index.py` (FastAPI 入口)。
*   **Timeout**: 設定 `maxDuration` 為 60 秒，給予 AI 足夠的生成時間。

### 環境變數 (.env)
*   `MONGODB_URI`: 資料庫連線字串。
*   `CLOUDINARY_URL`: 圖片託管服務。
*   `REPLICATE_API_TOKEN`: AI 模型金鑰。
*   `GEMINI_API_KEY`: (選用) 用於其他輔助功能。

---

## 5. 總結 (Conclusion)
本專案已經從一個單純的演示原型 (Prototype)，演華為具備 **高可用性 (High Availability)** 與 **容錯能力 (Fault Tolerance)** 的應用程式。透過引入 MongoDB 與 Fallback 機制，解決了 Serverless 環境下的資料持久化問題與外部 API 依賴風險。
